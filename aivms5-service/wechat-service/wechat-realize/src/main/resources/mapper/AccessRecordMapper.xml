<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.qlhx.dao.AccessRecordMapper">
	<resultMap id="BaseResultMap" type="com.qlhx.model.AccessRecord">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="rCode" property="rcode" jdbcType="VARCHAR" />
		<result column="parentID" property="parentid" jdbcType="INTEGER" />
		<result column="vID" property="vid" jdbcType="INTEGER" />
		<result column="uID" property="uid" jdbcType="INTEGER" />
		<result column="createTime" property="createtime" jdbcType="VARCHAR" />
		<result column="startTime" property="starttime" jdbcType="VARCHAR" />
		<result column="endTime" property="endtime" jdbcType="VARCHAR" />
		<result column="logOffTime" property="logofftime" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="reasons" property="reasons" jdbcType="VARCHAR" />
		<result column="unit" property="unit" jdbcType="VARCHAR" />
		<result column="num" property="num" jdbcType="INTEGER" />
		<result column="type" property="type" jdbcType="INTEGER" />
		<result column="isPrintVoucher" property="isprintvoucher"
			jdbcType="INTEGER" />
		<result column="isPullCard" property="ispullcard" jdbcType="INTEGER" />
		<result column="cardType" property="cardtype" jdbcType="INTEGER" />
		<result column="CardNum" property="cardnum" jdbcType="VARCHAR" />
		<result column="sitePhoto" property="sitephoto" jdbcType="VARCHAR" />
		<result column="isUpload" property="isUpload" jdbcType="INTEGER" />
		<result column="yyID" property="yyID" jdbcType="INTEGER" />
	</resultMap>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		id, rCode, parentID, vID, uID, createTime, startTime, endTime,
		logOffTime, status,
		reasons, unit, num, type, isPrintVoucher,
		isPullCard, cardType, CardNum,
		sitePhoto,isUpload,yyID
	</sql>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		select
		<include refid="Base_Column_List" />
		from u_access_record
		where id = #{id,jdbcType=INTEGER}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		delete from u_access_record
		where id = #{id,jdbcType=INTEGER}
	</delete>
	<insert id="insert" parameterType="com.qlhx.model.AccessRecord">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into u_access_record (id, rCode, parentID,
		vID, uID, createTime,
		startTime, endTime, logOffTime,
		status, reasons, unit,
		num, type,
		isPrintVoucher,
		isPullCard, cardType, CardNum,
		sitePhoto)
		values
		(#{id,jdbcType=INTEGER}, #{rcode,jdbcType=VARCHAR},
		#{parentid,jdbcType=INTEGER},
		#{vid,jdbcType=INTEGER},
		#{uid,jdbcType=INTEGER}, #{createtime,jdbcType=VARCHAR},
		#{starttime,jdbcType=VARCHAR}, #{endtime,jdbcType=VARCHAR},
		#{logofftime,jdbcType=VARCHAR},
		#{status,jdbcType=INTEGER},
		#{reasons,jdbcType=VARCHAR}, #{unit,jdbcType=VARCHAR},
		#{num,jdbcType=INTEGER}, #{type,jdbcType=INTEGER},
		#{isprintvoucher,jdbcType=INTEGER},
		#{ispullcard,jdbcType=INTEGER},
		#{cardtype,jdbcType=INTEGER}, #{cardnum,jdbcType=VARCHAR},
		#{sitephoto,jdbcType=VARCHAR})
	</insert>
	<insert id="insertSelective" parameterType="com.qlhx.model.AccessRecord"
		useGeneratedKeys="true" keyProperty="id">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into u_access_record
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="rcode != null">
				rCode,
			</if>
			<if test="parentid != null">
				parentID,
			</if>
			<if test="vid != null">
				vID,
			</if>
			<if test="vname != null">
				vname,
			</if>
			<if test="uid != null">
				uID,
			</if>
			<if test="uname != null">
				uname,
			</if>
			<if test="primaryId != null">
				primaryId,
			</if>
			<if test="companyCode != null">
				companyCode,
			</if>
			<if test="areaCode != null">
				areaCode,
			</if>
			<if test="terminalCode != null">
				terminalCode,
			</if>
			<if test="createtime != null">
				createTime,
			</if>
			<if test="starttime != null">
				startTime,
			</if>
			<if test="endtime != null">
				endTime,
			</if>
			<if test="logofftime != null">
				logOffTime,
			</if>
			<if test="status != null">
				status,
			</if>
			<if test="reasons != null">
				reasons,
			</if>
			<if test="unit != null">
				unit,
			</if>
			<if test="num != null">
				num,
			</if>
			<if test="type != null">
				type,
			</if>
			<if test="isprintvoucher != null">
				isPrintVoucher,
			</if>
			<if test="ispullcard != null">
				isPullCard,
			</if>
			<if test="cardtype != null">
				cardType,
			</if>
			<if test="cardnum != null">
				CardNum,
			</if>
			<if test="sitephoto != null">
				sitePhoto,
			</if>
			<if test="isUpload != null">
				isUpload,
			</if>
			<if test="yyID != null">
				yyID,
			</if>
			<if test="native_createDate != null">
				native_createDate,
			</if>
			<if test="native_updateDate != null">
				native_updateDate,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=INTEGER},
			</if>
			<if test="rcode != null">
				#{rcode,jdbcType=VARCHAR},
			</if>
			<if test="parentid != null">
				#{parentid,jdbcType=INTEGER},
			</if>
			<if test="vid != null">
				#{vid,jdbcType=INTEGER},
			</if>
			<if test="vname != null">
				#{vname,jdbcType=INTEGER},
			</if>
			<if test="uid != null">
				#{uid,jdbcType=INTEGER},
			</if>
			<if test="uname != null">
				#{uname,jdbcType=INTEGER},
			</if>
			<if test="primaryId != null">
				#{primaryId,jdbcType=BIGINT},
			</if>
			<if test="companyCode != null">
				#{companyCode,jdbcType=VARCHAR},
			</if>
			<if test="areaCode != null">
				#{areaCode,jdbcType=VARCHAR},
			</if>
			<if test="terminalCode != null">
				#{terminalCode,jdbcType=VARCHAR},
			</if>
			<if test="createtime != null">
				#{createtime,jdbcType=VARCHAR},
			</if>
			<if test="starttime != null">
				#{starttime,jdbcType=VARCHAR},
			</if>
			<if test="endtime != null">
				#{endtime,jdbcType=VARCHAR},
			</if>
			<if test="logofftime != null">
				#{logofftime,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				#{status,jdbcType=INTEGER},
			</if>
			<if test="reasons != null">
				#{reasons,jdbcType=VARCHAR},
			</if>
			<if test="unit != null">
				#{unit,jdbcType=VARCHAR},
			</if>
			<if test="num != null">
				#{num,jdbcType=INTEGER},
			</if>
			<if test="type != null">
				#{type,jdbcType=INTEGER},
			</if>
			<if test="isprintvoucher != null">
				#{isprintvoucher,jdbcType=INTEGER},
			</if>
			<if test="ispullcard != null">
				#{ispullcard,jdbcType=INTEGER},
			</if>
			<if test="cardtype != null">
				#{cardtype,jdbcType=INTEGER},
			</if>
			<if test="cardnum != null">
				#{cardnum,jdbcType=VARCHAR},
			</if>
			<if test="sitephoto != null">
				#{sitephoto,jdbcType=VARCHAR},
			</if>
			<if test="isUpload != null">
				#{isUpload,jdbcType=INTEGER},
			</if>
			<if test="yyID != null">
				#{yyID,jdbcType=INTEGER},
			</if>
			<if test="native_createDate != null">
				#{native_createDate},
			</if>
			<if test="native_updateDate != null">
				#{native_updateDate},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.qlhx.model.AccessRecord">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update u_access_record
		<set>
			<if test="rcode != null">
				rCode = #{rcode,jdbcType=VARCHAR},
			</if>
			<if test="parentid != null">
				parentID = #{parentid,jdbcType=INTEGER},
			</if>
			<if test="vid != null">
				vID = #{vid,jdbcType=INTEGER},
			</if>
			<if test="uid != null">
				uID = #{uid,jdbcType=INTEGER},
			</if>
			<if test="createtime != null">
				createTime = #{createtime,jdbcType=VARCHAR},
			</if>
			<if test="starttime != null">
				startTime = #{starttime,jdbcType=VARCHAR},
			</if>
			<if test="endtime != null">
				endTime = #{endtime,jdbcType=VARCHAR},
			</if>
			<if test="logofftime != null">
				logOffTime = #{logofftime,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				status = #{status,jdbcType=INTEGER},
			</if>
			<if test="reasons != null">
				reasons = #{reasons,jdbcType=VARCHAR},
			</if>
			<if test="unit != null">
				unit = #{unit,jdbcType=VARCHAR},
			</if>
			<if test="num != null">
				num = #{num,jdbcType=INTEGER},
			</if>
			<if test="type != null">
				type = #{type,jdbcType=INTEGER},
			</if>
			<if test="isprintvoucher != null">
				isPrintVoucher = #{isprintvoucher,jdbcType=INTEGER},
			</if>
			<if test="ispullcard != null">
				isPullCard = #{ispullcard,jdbcType=INTEGER},
			</if>
			<if test="cardtype != null">
				cardType = #{cardtype,jdbcType=INTEGER},
			</if>
			<if test="cardnum != null">
				CardNum = #{cardnum,jdbcType=VARCHAR},
			</if>
			<if test="sitephoto != null">
				sitePhoto = #{sitephoto,jdbcType=VARCHAR},
			</if>
			<if test="isUpload != null">
				isUpload = #{isUpload,jdbcType=INTEGER},
			</if>
			<if test="yyID != null">
				yyID = #{yyID,jdbcType=INTEGER},
			</if>
			<if test="native_updateDate != null">
				native_updateDate = #{native_updateDate},
			</if>
			<if test="uploadPoliceTime != null">
				uploadPoliceTime = #{uploadPoliceTime},
			</if>
			<if test="uploadPoliceStatus != null">
				uploadPoliceStatus = #{uploadPoliceStatus},
			</if>
			<if test="uploadPoliceResult != null">
				uploadPoliceResult = #{uploadPoliceResult},
			</if>
		</set>
		where primaryId = #{primaryId,jdbcType=INTEGER}
	</update>
	<update id="updateByCompanyCodeAndId" parameterType="com.qlhx.model.AccessRecord">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update u_access_record
		<set>
			<if test="rcode != null">
				rCode = #{rcode,jdbcType=VARCHAR},
			</if>
			<if test="parentid != null">
				parentID = #{parentid,jdbcType=INTEGER},
			</if>
			<if test="vid != null">
				vID = #{vid,jdbcType=INTEGER},
			</if>
			<if test="uid != null">
				uID = #{uid,jdbcType=INTEGER},
			</if>
			<if test="createtime != null">
				createTime = #{createtime,jdbcType=VARCHAR},
			</if>
			<if test="starttime != null">
				startTime = #{starttime,jdbcType=VARCHAR},
			</if>
			<if test="endtime != null">
				endTime = #{endtime,jdbcType=VARCHAR},
			</if>
			<if test="logofftime != null">
				logOffTime = #{logofftime,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				status = #{status,jdbcType=INTEGER},
			</if>
			<if test="reasons != null">
				reasons = #{reasons,jdbcType=VARCHAR},
			</if>
			<if test="unit != null">
				unit = #{unit,jdbcType=VARCHAR},
			</if>
			<if test="num != null">
				num = #{num,jdbcType=INTEGER},
			</if>
			<if test="type != null">
				type = #{type,jdbcType=INTEGER},
			</if>
			<if test="isprintvoucher != null">
				isPrintVoucher = #{isprintvoucher,jdbcType=INTEGER},
			</if>
			<if test="ispullcard != null">
				isPullCard = #{ispullcard,jdbcType=INTEGER},
			</if>
			<if test="cardtype != null">
				cardType = #{cardtype,jdbcType=INTEGER},
			</if>
			<if test="cardnum != null">
				CardNum = #{cardnum,jdbcType=VARCHAR},
			</if>
			<if test="sitephoto != null">
				sitePhoto = #{sitephoto,jdbcType=VARCHAR},
			</if>
			<if test="isUpload != null">
				isUpload = #{isUpload,jdbcType=INTEGER},
			</if>
			<if test="yyID != null">
				yyID = #{yyID,jdbcType=INTEGER},
			</if>
			<if test="native_updateDate != null">
				native_updateDate = #{native_updateDate},
			</if>
		</set>
		where areaCode = #{areaCode,jdbcType=VARCHAR} and id = #{id,jdbcType=BIGINT}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.qlhx.model.AccessRecord">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update u_access_record
		set rCode = #{rcode,jdbcType=VARCHAR},
		parentID =
		#{parentid,jdbcType=INTEGER},
		vID = #{vid,jdbcType=INTEGER},
		uID =
		#{uid,jdbcType=INTEGER},
		createTime = #{createtime,jdbcType=VARCHAR},
		startTime = #{starttime,jdbcType=VARCHAR},
		endTime =
		#{endtime,jdbcType=VARCHAR},
		logOffTime =
		#{logofftime,jdbcType=VARCHAR},
		status = #{status,jdbcType=INTEGER},
		reasons = #{reasons,jdbcType=VARCHAR},
		unit = #{unit,jdbcType=VARCHAR},
		num = #{num,jdbcType=INTEGER},
		type = #{type,jdbcType=INTEGER},
		isPrintVoucher = #{isprintvoucher,jdbcType=INTEGER},
		isPullCard =
		#{ispullcard,jdbcType=INTEGER},
		cardType =
		#{cardtype,jdbcType=INTEGER},
		CardNum = #{cardnum,jdbcType=VARCHAR},
		sitePhoto = #{sitephoto,jdbcType=VARCHAR}
		where id =
		#{id,jdbcType=INTEGER}
	</update>


	<!-- 门禁卡是否被占用 -->
	<select id="selectByCardNum" resultType="com.qlhx.model.AccessRecord">
		SELECT * FROM
		u_access_record WHERE CardNum=#{cardNum} AND status=0
	</select>

	<!-- 查询当天放出出入人数 -->
	<select id="findTodayIntoAndOutNum" resultType="java.util.Map">
		SELECT SUM(CASE
		WHEN status=0 THEN 1 ELSE 0 END) intoNum,SUM(CASE WHEN status in (1,2)
		THEN 1 ELSE 0 END) outNum
		FROM u_access_record WHERE
		DATE_FORMAT(startTime,'%Y-%m-%d') = #{date}
	</select>

	<!-- 根据来访人id查询该访客未被注销的来访 -->
	<select id="findRecordingByVisitorId" resultType="com.qlhx.model.AccessRecord">
		SELECT * FROM
		u_access_record WHERE vID=#{vId} AND status in(0,3) ORDER BY id DESC
	</select>


	<resultMap id="ResultAccessRecord" type="com.qlhx.model.AccessRecord"
		extends="BaseResultMap">
		<!-- 来访人信息 -->
		<association property="visitor" column="vID"
			javaType="com.qlhx.model.Visitor" select="com.qlhx.dao.VisitorMapper.selectByPrimaryKey">
		</association>
		<!-- 被访人信息 -->
		<association property="user" column="uID"
			javaType="com.qlhx.model.UUser"
			select="com.qlhx.dao.UUserMapper.selectUserInfoByPrimaryKey">
			<id column="id" property="id" jdbcType="BIGINT" />
			<result column="nickname" property="nickname" jdbcType="VARCHAR" />
			<result column="sex" property="sex" jdbcType="INTEGER" />
			<result column="nation" property="nation" jdbcType="INTEGER" />
			<result column="depID" property="depID" jdbcType="INTEGER" />
			<result column="syncId" property="syncId" jdbcType="INTEGER" />
		</association>
		<association property="dept" column="uID"
					 javaType="com.qlhx.model.Department" select="com.qlhx.dao.DepartmentMapper.selectDepartmentByVid">
			<id column="id" property="id" jdbcType="BIGINT" />
			<result column="syncId" property="syncId" jdbcType="INTEGER" />
			<result column="value" property="value" jdbcType="VARCHAR" />
		</association>
		<!-- 车辆信息 -->
		<association property="vCar" column="id"
			javaType="com.qlhx.model.VisitorCar" select="com.qlhx.dao.VisitorCarMapper.findCarByArId">
		</association>
		<!-- 带入物品 -->
		<collection property="drList" column="id" javaType="java.util.List"
			ofType="com.qlhx.model.DraginRes" select="com.qlhx.dao.DraginResMapper.findDraginResByarId">
		</collection>
		<!-- 带出物品 -->
		<collection property="trList" column="id" javaType="java.util.List"
			ofType="com.qlhx.model.TakeoutRes" select="com.qlhx.dao.TakeoutResMapper.findTakeOutResByarId">
		</collection>

	</resultMap>

	<!-- 查询访客记录信息 -->
	<select id="findAccessRecord" parameterType="com.qlhx.model.AccessRecord"
		resultMap="ResultAccessRecord">
		SELECT r.*,v.pinYin FROM u_access_record r LEFT JOIN u_visitor v ON
		r.vID=v.id
		<where>
			<if test="starttime != null">
				r.startTime <![CDATA[>=]]>
				#{starttime}
			</if>
			<if test="endtime != null">
				AND r.endTime <![CDATA[<=]]>
				DATE_ADD(#{endtime},INTERVAL 1 DAY)
			</if>
			<if test="status == null">
				AND r.status != 3
			</if>
			<if test="status != null and status == 0">
				AND r.status = 0
			</if>
			<if test="status != null and status == 1">
				AND r.status in(1,2)
			</if>
			<if test="visitor != null and visitor.pinYin != null">
				AND v.pinYin=#{visitor.pinYin}
			</if>
			<if test="cardnum != null">
				AND r.CardNum=#{cardnum}
			</if>
		</where>
		ORDER BY r.id DESC
		LIMIT ${(pageNum-1)*10},10
	</select>

	<select id="findAccessRecordPageCount" parameterType="com.qlhx.model.AccessRecord"
		resultType="java.lang.Integer">
		SELECT COUNT(0) FROM u_access_record r LEFT JOIN u_visitor v ON
		r.vID=v.id
		<where>
			<if test="starttime != null">
				r.startTime <![CDATA[>=]]>
				#{starttime}
			</if>
			<if test="endtime != null">
				AND r.endTime <![CDATA[<=]]>
				DATE_ADD(#{endtime},INTERVAL 1 DAY)
			</if>
			<if test="status == null">
				AND r.status != 3
			</if>
			<if test="status != null and status == 0">
				AND r.status = 0
			</if>
			<if test="status != null and status == 1">
				AND r.status in(1,2)
			</if>
			<if test="visitor != null and visitor.pinYin != null">
				AND v.pinYin=#{visitor.pinYin}
			</if>
			<if test="cardnum != null">
				AND r.CardNum=#{cardnum}
			</if>
		</where>
	</select>

	<!-- 根据卡号查询正在进行的访问记录 -->
	<select id="findAccessRecordByCardNum" resultMap="ResultAccessRecord">
		SELECT * FROM
		u_access_record WHERE status=0 AND CardNum=#{cardNum}
	</select>
	<!-- 根据访客ID查询正在进行的访问记录 -->
	<select id="findNowAccessRecordByVid" resultMap="ResultAccessRecord">
		SELECT * FROM
		u_access_record WHERE status=0 AND vID=#{vID}
	</select>
	<select id="findNotUploadAccessRecord" resultMap="ResultAccessRecord">
		SELECT r.*,v.issuing FROM
		u_access_record r, u_visitor v WHERE r.vID=v.id AND r.isUpload in(0) AND v.issuing!='' LIMIT ${num}
	</select>

	<select id="findAccessRecordByVid" resultMap="ResultAccessRecord">
		SELECT * FROM
		u_access_record WHERE vID=#{vID} AND status=3 AND type=1 ORDER BY id
		DESC
	</select>

	<select id="findLastAccessRecordByIdNum" resultMap="ResultAccessRecord">
		SELECT * FROM
		u_access_record WHERE vID in(SELECT id FROM u_visitor WHERE
		idNum=#{idNum}) ORDER BY id DESC LIMIT 1
	</select>

	<select id="findAccessRecordByid" resultMap="ResultAccessRecord">
		SELECT * FROM
		u_access_record WHERE ID=#{ID}
	</select>

	<!-- 判断指定预约是否存在 -->
	<select id="isAccessRecord" resultMap="ResultAccessRecord">
		SELECT r.*,v.idNum,v.name,v.phone,u.nickname,u.phone FROM
		u_access_record r LEFT JOIN u_visitor v ON
		r.vID=v.id LEFT JOIN u_user
		u ON r.uID=u.id
		<where>
			<if test="starttime != null">
				r.startTime = #{starttime}
			</if>
			<if test="endtime != null">
				AND r.endTime =#{endtime}
			</if>
			<if test="visitor !=null and visitor.name != null">
				AND v.name=#{visitor.name}
			</if>
			<if test="visitor !=null and visitor.idnum != null">
				AND v.idNum=#{visitor.idnum}
			</if>
			<if test="visitor !=null and visitor.phone != null">
				AND v.phone like  '%${visitor.phone}%'
			</if>
			<if test="user !=null and user.phone != null">
				AND u.phone like '%${user.phone}%'
			</if>
			AND r.type=1
		</where>
	</select>
	
	<select id="selectAccessRecordByPama" resultType="com.qlhx.model.AccessRecord">
		SELECT * FROM u_access_record
		WHERE 
		primaryId = #{primaryId} 
		AND companyCode = #{companyCode} 
		AND areaCode = #{areaCode}
		AND terminalCode = #{terminalCode}
		
	</select>
	
	<select id="visitorReasonCount" resultType="java.util.Map">
		SELECT reasons name,count(id) y FROM u_access_record group by reasons
		
	</select>
	
	
	<select id="newCountReportByMonth" resultType="java.util.Map">
		select DATE_FORMAT(m.startTime,'%Y-%m-%d') name ,count(m.id) y  
		from u_access_record m,u_company c where m.companyCode = c.companyCode 
		<if test="companyCode != null">
			and m.companyCode = #{companyCode}
		</if>
		and DATE_FORMAT(m.startTime,'%Y-%m') = #{yearMonth}
		GROUP BY DATE_FORMAT(m.startTime,'%Y-%m-%d') 
		order by m.startTime
	</select>
	
	<select id="newCountReportByYear" resultType="java.util.Map">
		select DATE_FORMAT(m.startTime,'%Y-%m') name ,count(m.id) y  
		from u_access_record m,u_company c where m.companyCode = c.companyCode 
		<if test="companyCode != null">
			and m.companyCode = #{companyCode}
		</if>
		and DATE_FORMAT(m.startTime,'%Y') = #{year}
		GROUP BY DATE_FORMAT(m.startTime,'%Y-%m') 
		order by m.startTime
	</select>
	
	<select id="visitedDurationByMonth" resultType="java.util.Map">
		select DATE_FORMAT(m.startTime,'%Y-%m-%d') name ,sum(CONVERT((UNIX_TIMESTAMP(endTime) - UNIX_TIMESTAMP(startTime))/60/60,DECIMAL(10,2))) y  
		from u_access_record m,u_company c where m.companyCode = c.companyCode 
		<if test="companyCode != null">
			and m.companyCode = #{companyCode}
		</if>
		and DATE_FORMAT(m.startTime,'%Y-%m') = #{yearMonth}
		GROUP BY DATE_FORMAT(m.startTime,'%Y-%m-%d') 
		order by m.startTime
	</select>
	
	<select id="visitedDurationByYear" resultType="java.util.Map">
		select DATE_FORMAT(m.startTime,'%Y-%m') name ,sum(CONVERT((UNIX_TIMESTAMP(endTime) - UNIX_TIMESTAMP(startTime))/60/60,DECIMAL(10,2))) y  
		from u_access_record m,u_company c where m.companyCode = c.companyCode 
		<if test="companyCode != null">
			and m.companyCode = #{companyCode}
		</if>
		and DATE_FORMAT(m.startTime,'%Y') = #{year}
		GROUP BY DATE_FORMAT(m.startTime,'%Y-%m') 
		order by m.startTime
	</select>
	
	
	<select id="policeByMonth" resultType="java.util.Map">
		select DATE_FORMAT(m.uploadPoliceTime,'%Y-%m-%d') name ,count(m.id) y  
		from u_access_record m,u_company c where m.companyCode = c.companyCode 
		<if test="companyCode != null">
			and m.companyCode = #{companyCode}
		</if>
		and DATE_FORMAT(m.uploadPoliceTime,'%Y-%m') = #{yearMonth}
		and m.uploadPoliceTime is not null
		GROUP BY DATE_FORMAT(m.uploadPoliceTime,'%Y-%m-%d') 
		order by m.uploadPoliceTime
	</select>
	
	<select id="policeByYear" resultType="java.util.Map">
		select DATE_FORMAT(m.uploadPoliceTime,'%Y-%m') name ,count(m.id) y  
		from u_access_record m,u_company c where m.companyCode = c.companyCode 
		<if test="companyCode != null">
			and m.companyCode = #{companyCode}
		</if>
		and DATE_FORMAT(m.uploadPoliceTime,'%Y') = #{year}
		and m.uploadPoliceTime is not null
		GROUP BY DATE_FORMAT(m.uploadPoliceTime,'%Y-%m') 
		order by m.uploadPoliceTime
	</select>

	<select id="selectByLastCreateTime" resultType="com.qlhx.model.VisitorRecord">

		SELECT
		ar.primaryId id,
		ar.CardNum activity_no,
		ar.reasons activity_desc,
		ar.createTime addtime,
		u.nickname owner_name,
		u.phone owner_tel,
		v.`name` visitor_name,
		v.phone visitor_tel,
		ar.unit visitor_company,
		ar.startTime starttime,
		ar.endTime endtime,
		ar.CardNum card_num,
		ar.`status`
		FROM
		u_access_record ar,
		u_member u,
		u_visitor v
		WHERE
		ar.vID = v.id
		AND ar.uID = u.id
		and ar.CardNum is not null
		and ar.status = 0
		and ar.isUpload = 0
		<if test="lastCreateTime !=null and lastCreateTime != null">
		  and ar.createTime &gt; #{lastCreateTime}
		</if>
	</select>
	
	<select id="selectUploadToB" resultType="com.qlhx.model.VisitorRecord">

	SELECT
	pd.id,
	pd.applyid activity_no,
	pp.reson activity_desc,
	pd.tabTime addtime,
	emp.uname owner_name,
	emp.utel owner_tel,
	pd.uname visitor_name,
	pd.utel visitor_tel,
	vis.company visitor_company,
	pp.starttime starttime,
	pp.endtime endtime,
	pd.cardNum card_num
	FROM
	u_preapplygoup pp
	INNER JOIN u_preapplygoupdetail pd ON pp.syncid = pd.syncid
	LEFT JOIN u_wxuser emp ON pp.uid = emp.uid
	LEFT JOIN u_wxuser vis ON pd.openid = vis.openid
	where pd.cardNum is not null and pd.tabTime > '2018-6-10 11:16:15' and pd.isPush = 0
	limit 0,5

</select>

<select id="vistorSmsInfo" resultType="com.qlhx.model.VistorSmsInfo">

	SELECT
	emp.uname employeeName,
	emp.department employeeDep,
	pd.uname vistorName,
	pp.starttime vistorTime,
	pd.cardNum qrCode
	FROM
	u_preapplygoup pp
	INNER JOIN u_preapplygoupdetail pd ON pp.syncid = pd.syncid
	LEFT JOIN u_wxuser emp ON pp.uid = emp.uid
	LEFT JOIN u_wxuser vis ON pd.openid = vis.openid
	where pd.id=#{id}
	limit 0,1

</select>

</mapper>