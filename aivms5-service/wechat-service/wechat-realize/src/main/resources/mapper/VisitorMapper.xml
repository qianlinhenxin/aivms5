<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.qlhx.dao.VisitorMapper">

	<resultMap id="BaseResultMap" type="com.qlhx.model.Visitor">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="sex" property="sex" jdbcType="VARCHAR" />
		<result column="nation" property="nation" jdbcType="VARCHAR" />
		<result column="birthday" property="birthday" jdbcType="VARCHAR" />
		<result column="address" property="address" jdbcType="VARCHAR" />
		<result column="idNum" property="idnum" jdbcType="VARCHAR" />
		<result column="photo" property="photo" jdbcType="VARCHAR" />
		<result column="issuing" property="issuing" jdbcType="VARCHAR" />
		<result column="validityDateStart" property="validitydatestart"
			jdbcType="VARCHAR" />
		<result column="validityDateEnd" property="validitydateend"
			jdbcType="VARCHAR" />
		<result column="phone" property="phone" jdbcType="VARCHAR" />
		<result column="pinYin" property="pinYin" jdbcType="VARCHAR" />
		<result column="vid" property="vid" jdbcType="INTEGER" />
	</resultMap>

	<resultMap id="ResultAccessRecord" type="com.qlhx.model.VisitorRecordBo">
		<!-- 车辆信息
		<association property="vCar" column="id"
					 javaType="com.qlhx.model.VisitorCar" select="com.qlhx.dao.VisitorCarMapper.findCarByArId">
		</association>
		 -->
		<!-- 带入物品 
		<collection property="drList" column="id" javaType="java.util.List"
					ofType="com.qlhx.model.DraginRes" select="com.qlhx.dao.DraginResMapper.findDraginResByarId">
		</collection>
		-->
		<!-- 带出物品
		<collection property="trList" column="id" javaType="java.util.List"
					ofType="com.qlhx.model.TakeoutRes" select="com.qlhx.dao.TakeoutResMapper.findTakeOutResByarId">
		</collection>
		 -->
	</resultMap>


	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		id, name, sex, nation, birthday, address, idNum, photo, issuing,
		validityDateStart,
		validityDateEnd, phone,pinYin,isbindfinger
	</sql>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		select
		<include refid="Base_Column_List" />
		from u_visitor
		where id = #{id,jdbcType=INTEGER}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		delete from u_visitor
		where id = #{id,jdbcType=INTEGER}
	</delete>
	<insert id="insert" parameterType="com.qlhx.model.Visitor">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into u_visitor (id, name, sex, nation,
		birthday, address, idNum,
		photo, issuing, validityDateStart,
		validityDateEnd, phone)
		values
		(#{id,jdbcType=INTEGER}, #{name,jdbcType=VARCHAR},
		#{sex,jdbcType=VARCHAR}, #{nation,jdbcType=VARCHAR},
		#{birthday,jdbcType=VARCHAR}, #{address,jdbcType=VARCHAR},
		#{idnum,jdbcType=VARCHAR},
		#{photo,jdbcType=VARCHAR},
		#{issuing,jdbcType=VARCHAR}, #{validitydatestart,jdbcType=VARCHAR},
		#{validitydateend,jdbcType=VARCHAR}, #{phone,jdbcType=VARCHAR})
	</insert>
	<insert id="insertSelective" parameterType="com.qlhx.model.Visitor"
		useGeneratedKeys="true" keyProperty="id">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->

		insert into u_visitor
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="primaryId != null">
				primaryId,
			</if>
			<if test="companyCode != null">
				companyCode,
			</if>
			<if test="areaCode != null">
				areaCode,
			</if>
			<if test="terminalCode != null">
				terminalCode,
			</if>
			<if test="name != null">
				name,
			</if>
			<if test="sex != null">
				sex,
			</if>
			<if test="nation != null">
				nation,
			</if>
			<if test="birthday != null">
				birthday,
			</if>
			<if test="address != null">
				address,
			</if>
			<if test="idnum != null">
				idNum,
			</if>
			<if test="photo != null">
				photo,
			</if>
			<if test="issuing != null">
				issuing,
			</if>
			<if test="validitydatestart != null">
				validityDateStart,
			</if>
			<if test="validitydateend != null">
				validityDateEnd,
			</if>
			<if test="phone != null">
				phone,
			</if>
			<if test="pinYin != null">
				pinYin,
			</if>
			<if test="native_createDate != null">
				native_createDate,
			</if>
			<if test="native_updateDate != null">
				native_updateDate,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=INTEGER},
			</if>
			<if test="primaryId != null">
				#{primaryId,jdbcType=BIGINT},
			</if>
			<if test="companyCode != null">
				#{companyCode,jdbcType=VARCHAR},
			</if>
			<if test="areaCode != null">
				#{areaCode,jdbcType=VARCHAR},
			</if>
			<if test="terminalCode != null">
				#{terminalCode,jdbcType=VARCHAR},
			</if>
			<if test="name != null">
				#{name,jdbcType=VARCHAR},
			</if>
			<if test="sex != null">
				#{sex,jdbcType=VARCHAR},
			</if>
			<if test="nation != null">
				#{nation,jdbcType=VARCHAR},
			</if>
			<if test="birthday != null">
				#{birthday,jdbcType=VARCHAR},
			</if>
			<if test="address != null">
				#{address,jdbcType=VARCHAR},
			</if>
			<if test="idnum != null">
				#{idnum,jdbcType=VARCHAR},
			</if>
			<if test="photo != null">
				#{photo,jdbcType=VARCHAR},
			</if>
			<if test="issuing != null">
				#{issuing,jdbcType=VARCHAR},
			</if>
			<if test="validitydatestart != null">
				#{validitydatestart,jdbcType=VARCHAR},
			</if>
			<if test="validitydateend != null">
				#{validitydateend,jdbcType=VARCHAR},
			</if>
			<if test="phone != null">
				#{phone,jdbcType=VARCHAR},
			</if>
			<if test="pinYin != null">
				#{pinYin,jdbcType=VARCHAR},
			</if>
			<if test="native_createDate != null">
				#{native_createDate},
			</if>
			<if test="native_updateDate != null">
				#{native_updateDate},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.qlhx.model.Visitor">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update u_visitor
		<set>
			<if test="name != null">
				name = #{name,jdbcType=VARCHAR},
			</if>
			<if test="sex != null">
				sex = #{sex,jdbcType=VARCHAR},
			</if>
			<if test="nation != null">
				nation = #{nation,jdbcType=VARCHAR},
			</if>
			<if test="birthday != null">
				birthday = #{birthday,jdbcType=VARCHAR},
			</if>
			<if test="address != null">
				address = #{address,jdbcType=VARCHAR},
			</if>
			<if test="idnum != null">
				idNum = #{idnum,jdbcType=VARCHAR},
			</if>
			<if test="photo != null">
				photo = #{photo,jdbcType=VARCHAR},
			</if>
			<if test="issuing != null">
				issuing = #{issuing,jdbcType=VARCHAR},
			</if>
			<if test="validitydatestart != null">
				validityDateStart =
				#{validitydatestart,jdbcType=VARCHAR},
			</if>
			<if test="validitydateend != null">
				validityDateEnd = #{validitydateend,jdbcType=VARCHAR},
			</if>
			<if test="phone != null">
				phone = #{phone,jdbcType=VARCHAR},
			</if>
			<if test="pinYin != null">
				pinYin = #{pinYin,jdbcType=VARCHAR},
			</if>
			<if test="uploadPoliceTime != null">
				uploadPoliceTime = #{uploadPoliceTime},
			</if>
			<if test="uploadPoliceStatus != null">
				uploadPoliceStatus = #{uploadPoliceStatus},
			</if>
			<if test="uploadPoliceResult != null">
				uploadPoliceResult = #{uploadPoliceResult},
			</if>
		</set>
		where primaryId = #{primaryId,jdbcType=INTEGER}
	</update>
	<update id="updateByCompanyCodeAndId" parameterType="com.qlhx.model.Visitor">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update u_visitor
		<set>
			<if test="name != null">
				name = #{name,jdbcType=VARCHAR},
			</if>
			<if test="sex != null">
				sex = #{sex,jdbcType=VARCHAR},
			</if>
			<if test="nation != null">
				nation = #{nation,jdbcType=VARCHAR},
			</if>
			<if test="birthday != null">
				birthday = #{birthday,jdbcType=VARCHAR},
			</if>
			<if test="address != null">
				address = #{address,jdbcType=VARCHAR},
			</if>
			<if test="idnum != null">
				idNum = #{idnum,jdbcType=VARCHAR},
			</if>
			<if test="photo != null">
				photo = #{photo,jdbcType=VARCHAR},
			</if>
			<if test="issuing != null">
				issuing = #{issuing,jdbcType=VARCHAR},
			</if>
			<if test="validitydatestart != null">
				validityDateStart =
				#{validitydatestart,jdbcType=VARCHAR},
			</if>
			<if test="validitydateend != null">
				validityDateEnd = #{validitydateend,jdbcType=VARCHAR},
			</if>
			<if test="phone != null">
				phone = #{phone,jdbcType=VARCHAR},
			</if>
			<if test="pinYin != null">
				pinYin = #{pinYin,jdbcType=VARCHAR},
			</if>
			<if test="native_updateDate != null">
				native_updateDate = #{native_updateDate},
			</if>
		</set>
		where areaCode = #{areaCode,jdbcType=VARCHAR} and id = #{id,jdbcType=BIGINT}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.qlhx.model.Visitor">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update u_visitor
		set name = #{name,jdbcType=VARCHAR},
		sex =
		#{sex,jdbcType=VARCHAR},
		nation = #{nation,jdbcType=VARCHAR},
		birthday =
		#{birthday,jdbcType=VARCHAR},
		address = #{address,jdbcType=VARCHAR},
		idNum = #{idnum,jdbcType=VARCHAR},
		photo = #{photo,jdbcType=VARCHAR},
		issuing = #{issuing,jdbcType=VARCHAR},
		validityDateStart =
		#{validitydatestart,jdbcType=VARCHAR},
		validityDateEnd =
		#{validitydateend,jdbcType=VARCHAR},
		phone =
		#{phone,jdbcType=VARCHAR}
		where id = #{id,jdbcType=INTEGER}
	</update>

	<!-- 根据访客身份证号码查询访客信息 -->
	<select id="findVisitorByIdNum" resultType="com.qlhx.model.Visitor">

		SELECT v.*,a.sitePhoto FROM
		u_visitor v LEFT JOIN u_access_record a
		on v.id = a.vID  WHERE idNum=#{idNum}
		ORDER BY a.id desc LIMIT 1
	</select>

	<sql id="limit_sql">
		<if test="page_sql != null and page_sql != ''">
			${page_sql}
		</if>
	</sql>

	<select id="findVisitorRecord" resultMap="ResultAccessRecord">
		SELECT
		v.id AS vid,
		v.`name`,
		v.idNum,
		v.phone,
		r.id,
		r.rCode,
		r.vID,
		r.uID,
		r.createTime,
		u.nickname,
		r.startTime,
		r.endTime,
		r.logOffTime,
		r.`status`,
		r.reasons,
		r.unit,
		r.num,
		r.type,
		r.isPrintVoucher,
		r.isPullCard,
		r.cardType,
		r.CardNum,
		r.sitePhoto,
		r.uploadPoliceTime,
		r.uploadPoliceStatus,
		r.uploadPoliceResult,
		<!-- 
		(SELECT COUNT(1) FROM u_access_record WHERE parentID = r.id)
		childCount,
		 -->
		c.companyName
		FROM
	    u_access_record AS r
        LEFT JOIN u_visitor AS v ON v.id = r.vID and r.areaCode = v.areaCode
        LEFT JOIN u_member AS u ON u.id = r.uID and r.areaCode = u.areaCode
        LEFT JOIN u_company AS c ON r.companyCode = c.companyCode
		<include refid="where_VRall" />
		<!--  order by r.native_createDate desc -->
		<include refid="limit_sql" />
	</select>
	<select id="findVisitorRecordCount" resultType="java.lang.Integer">
	SELECT
	COUNT(*)
	FROM
	u_access_record where 1 = 1
    <if test="vids != null and vids !='' ">
           and vid in 
          <foreach collection="vids" index="index" item="item" open="(" separator="," close=")">
               #{item}       
          </foreach>
	</if>
	<if test="start != null and start !=''">
		and startTime <![CDATA[>=]]> '${start}'
	</if>
	<if test="end != null and end !=''">
		and endTime  <![CDATA[<=]]> '${end}'
	</if>
	<if test="companyCode != null and companyCode !='' ">
		and companyCode = #{companyCode,jdbcType=VARCHAR}
	</if>
	<if test="areaCode != null and areaCode !='' ">
		and areaCode = #{areaCode,jdbcType=VARCHAR}
	</if>
	<if test="today != null and today !='' ">
		and DATE_FORMAT(now(),'%Y-%m-%d') = DATE_FORMAT(native_createDate,'%Y-%m-%d')
	</if>
	<if test="vids == null and startTime == null and endTime == null and companyCode == null and areaCode == null">
	    and vid > 0 
	</if>
	
    
</select>
	<!-- 根据访客凭证二维码或一维码信息查询未注销的访客信息 -->
	<select id="findVisitorByRCode" resultType="com.qlhx.model.Visitor">
SELECT v.*,a.sitePhoto FROM
		u_visitor v JOIN u_access_record a on v.id = a.vID AND a.rCode = #{rCode} AND status=0	ORDER BY a.id desc LIMIT 1
	</select>
	<!--访客记录where -->
	<sql id="where_VRall">
		<where>
		    <!-- 
			<if test="parentId == null or parentId == ''">
				parentID = 0
			</if>
			 -->
			<if test="parentId != null and parentId != ''">
				and parentID = ${parentId}
			</if>

			<if test="name != null and name !='' ">
				and v.name = #{name,jdbcType=VARCHAR}
			</if>
			<if test="status != null  ">
				and r.status =${status}
			</if>
			<if test="start != null and start !=''">
				and r.startTime <![CDATA[>=]]>
				'${start}'
			</if>
			<if test="end != null and end !=''">
				and r.endTime  <![CDATA[<=]]>
				'${end}'
			</if>
			<if test="companyCode != null and companyCode !='' ">
				and r.companyCode = #{companyCode,jdbcType=VARCHAR}
			</if>
			<if test="areaCode != null and areaCode !='' ">
				and r.areaCode = #{areaCode,jdbcType=VARCHAR}
			</if>
			<if test="today != null and today !='' ">
				and DATE_FORMAT(now(),'%Y-%m-%d') = DATE_FORMAT(r.native_createDate,'%Y-%m-%d')
			</if>
			and r.vid > 0
		</where>
	</sql>
	<!--访客信息查询 -->
	<select id="findAll" resultType="com.qlhx.model.Visitor">
		SELECT u.*,c.companyName FROM u_visitor u
		left join u_company c on c.companyCode = u.companyCode
		<include refid="where_all" />
		order by u.native_createDate desc
		<include refid="limit_sql" />
	</select>
	<select id="findCount" resultType="java.lang.Integer">
		SELECT COUNT(1) FROM u_visitor u
		<include refid="where_all" />
	</select>
	<!--访客信息where -->
	<sql id="where_all">
		<where>
			<if test="name != null and name !='' ">
				and u.name like CONCAT("%",#{name,jdbcType=VARCHAR},"%")
			</if>
			<if test="cardId != null and cardId !='' ">
				and u.idnum like CONCAT("%",#{cardId,jdbcType=VARCHAR},"%")
			</if>
			<if test="companyCode != null and companyCode !='' ">
				and u.companyCode = #{companyCode,jdbcType=VARCHAR}
			</if>
			<if test="areaCode != null and areaCode !='' ">
				and u.areaCode = #{areaCode,jdbcType=VARCHAR}
			</if>
			<if test="today != null and today !='' ">
				and DATE_FORMAT(now(),'%Y-%m-%d') = DATE_FORMAT(u.native_createDate,'%Y-%m-%d')
			</if>
		</where>
	</sql>


	<select id="findVisitorOrderList" resultType="com.qlhx.model.VisitorRecordBo">
		SELECT
		v.id AS vid,
		v.`name`,
		v.sex,
		v.nation,
		v.birthday,
		v.address,
		v.photo,
		v.idNum,
		v.issuing,
		v.validityDateStart,
		v.validityDateEnd,
		v.phone,
		r.id,
		r.rCode,
		r.vID,
		r.uID,
		r.createTime,
		u.nickname,
		r.startTime,
		r.endTime,
		r.logOffTime,
		r.`status`,
		r.reasons,
		r.unit,
		r.num,
		r.type
		FROM
		u_visitor AS v
		JOIN u_access_record AS r ON v.id = r.vID
		LEFT JOIN
		u_user AS u ON u.id = r.uID
		<include refid="where_Order" />
		ORDER BY createTime DESC
		<include refid="limit_sql" />
	</select>
	<select id="findVisitorOrderListCount" resultType="java.lang.Integer">
		SELECT
		COUNT(1)
		FROM
		u_visitor AS v
		JOIN u_access_record AS r ON v.id =
		r.vID
		LEFT JOIN u_user AS u ON u.id = r.uID
		<include refid="where_Order" />
	</select>
	<!--预约访客记录where -->
	<sql id="where_Order">
		<where>
			r.type = 1
			<if test="parentId == null or parentId == ''">
				AND (parentID ='' OR parentID is null)
			</if>
			<if test="idnum != null and idnum != ''">
				and v.idNum like
				CONCAT("%",#{idnum,jdbcType=VARCHAR})
			</if>
			<if test="name != null and name !='' ">
				and v.name like CONCAT("%",#{name,jdbcType=VARCHAR},"%")
			</if>
			<if test="status != null and status !='' ">
				and r.status =${status}
			</if>
			<if test="start != null and start !=''">
				and r.startTime <![CDATA[>=]]>
				'${start}'
			</if>
			<if test="end != null and end !=''">
				and r.endTime  <![CDATA[<=]]>
				'${end}'
			</if>
		</where>
	</sql>
	<!--根据身份证查询访客预约数量 -->
	<select id="findOrderVisitorByIdNumCount" resultType="java.lang.Integer">
		SELECT
		COUNT(1)
		FROM
		u_visitor v
		JOIN u_access_record r ON v.id = r.vID
		WHERE
		type = 1 AND r.status = 0
		AND v.idNum = '${idNum}'
	</select>

	<!--根据流水ID查询预约记录 -->
	<select id="findOrderVisitorByRId" resultType="com.qlhx.model.VisitorRecordBo">
		SELECT
		v.id AS
		vid,v.`name`,v.sex,v.nation,v.birthday,v.address,v.photo,v.idNum,v.issuing,v.validityDateStart,v.validityDateEnd,v.phone,r.id,r.rCode,
		r.vID,r.uID,r.createTime,u.nickname,r.startTime,r.endTime,r.logOffTime,r.`status`,r.reasons,r.unit,r.num,r.type
		FROM
		u_visitor v
		JOIN u_access_record r ON v.id = r.vID
		JOIN u_user u ON
		r.uID = u.id
		WHERE
		type = 1 AND r.status = 3
		AND r.id = ${id}
		LIMIT 0,1
	</select>


	<!-- 根据ic卡号查询当前正在进行访问的访客信息 -->
	<select id="findVisitorByIcNum" resultType="com.qlhx.model.Visitor">

select v.*,a.sitePhoto from u_visitor v join u_access_record a
on  v.id = a.vID AND a.CardNum = #{icNum} AND status = 0
ORDER BY a.id DESC LIMIT 0,1
	</select>


	<select id="findVisitorStatistics" resultType="com.qlhx.model.VisitorStatistics">
		SELECT count( 1 )
		count,r.createTime,r.startTime,r.endTime,r.logOffTime,u.nickname,
		u.`status`,u.idNum,u.telephone,u.depID,d.value
		FROM
		u_access_record AS r
		JOIN u_user AS u
		ON r.uID = u.id
		JOIN u_department d
		ON d.id = u.depID
		<where>
			<if test="name != null and name !='' ">
				and u.nickname like
				CONCAT("%",#{name,jdbcType=VARCHAR},"%")
			</if>
			<if test="status != null and status !='' ">
				and r.status =${status}
			</if>
			<if test="start != null and start !=''">
				and r.startTime <![CDATA[>=]]>
				'${start}'
			</if>
			<if test="end != null and end !=''">
				and r.endTime  <![CDATA[<=]]>
				'${end}'
			</if>
			<if test="depart != null and depart !=''">
				and u.depID = '${depart}'
			</if>

		</where>
		GROUP BY
		uID
		ORDER BY count DESC
	</select>
	<select id="selectPhotoByVids" resultType="com.qlhx.model.VisitorRecordBo">
		SELECT
		photo,
		sitePhoto
		FROM
		u_access_record r
		JOIN u_visitor v ON r.vID =
		v.id
		<include refid="photo_where" />
	</select>

	<sql id="photo_where">
		<where>
			<if test="name != null and name !='' ">
				and v.name like CONCAT("%",#{name,jdbcType=VARCHAR},"%")
				OR v.idNum like CONCAT("%",#{name,jdbcType=VARCHAR},"%")
			</if>
			<if test="vIds != null and vIds!=''">
				AND v.id IN (${vIds})
			</if>
		</where>
	</sql>


	<!-- 根据访客身份证号查询该访客是否在黑名单 -->
	<select id="findBlackListByIdNum" resultType="com.qlhx.model.Visitor">
		SELECT v.* FROM
		u_blacklist b LEFT JOIN u_visitor v ON b.vId=v.id WHERE v.id in (
		SELECT id FROM u_visitor WHERE idNum=#{idNum}
		)
	</select>

	<!-- 根据来访人员身份号码判断该访客是否注销访问 -->
	<select id="isLogOff" resultType="com.qlhx.model.Visitor">
		SELECT v.*,r.sitePhoto FROM u_visitor v
		LEFT
		JOIN u_access_record r ON v.id=r.vID WHERE r.status=0 AND
		v.idNum=#{idNum} ORDER BY r.id DESC LIMIT 1
	</select>

	<!-- 根据来访人员身份号码判断该访客是否有预约 -->
	<select id="isAppointment" resultType="com.qlhx.model.Visitor">
		SELECT
		v.*,r.startTime,r.endTime FROM u_visitor
		v
		LEFT JOIN u_access_record r
		ON v.id=r.vID WHERE r.status=3 AND
		r.type=1 AND v.idNum=#{idNum}
	</select>

	<update id="UpateIsBindFinger" parameterType="java.lang.Integer">
		UPDATE u_visitor set isbindfinger =1 WHERE id=#{uid}
	</update>
	
	<select id="selectVisitorByPama" resultType="com.qlhx.model.Visitor">
		SELECT * FROM u_visitor
		WHERE 
		primaryId = #{primaryId} 
		AND companyCode = #{companyCode} 
		AND areaCode = #{areaCode}
		AND terminalCode = #{terminalCode}
		
	</select>
	
	<select id="selectVisitorToUploadPolice" resultType="java.util.Map">
		SELECT ar.primaryId record_id ,
		c.areaName village_name,
		v.name visitor_name,
		v.idnum identity_num,
		c.name area_name,
		c.police_code,
		c.police_name,
		c.police_son_code,
		c.police_son_name,
		c.village_address 
		FROM u_visitor v , u_access_record ar , u_area c
		WHERE v.areaCode = ar.areaCode and v.areaCode = c.areaCode and v.id = ar.vid
		and c.isUploadPolice = 1
		and (ar.uploadPoliceStatus is null or ar.uploadPoliceStatus = 0) and (ar.uploadPoliceTime is null or datediff(now() , ar.uploadPoliceTime) &gt;= #{days})
		order by ar.primaryId asc
		limit 0, #{pageSize}
	</select>
	
	<select id="reportByMonth" resultType="java.util.Map">
		select DATE_FORMAT(m.startTime,'%Y-%m-%d') name ,count(m.id) y  
		from u_access_record m,u_company c where m.companyCode = c.companyCode 
		<if test="companyCode != null">
			and m.companyCode = #{companyCode},
		</if>
		and DATE_FORMAT(m.startTime,'%Y-%m') = #{yearMonth}
		GROUP BY DATE_FORMAT(m.startTime,'%Y-%m-%d') 
		order by m.startTime
	</select>
	
	<select id="reportByYear" resultType="java.util.Map">
		select DATE_FORMAT(m.startTime,'%Y-%m') name ,count(m.id) y  
		from u_access_record m,u_company c where m.companyCode = c.companyCode 
		<if test="companyCode != null">
			and m.companyCode = #{companyCode},
		</if>
		and DATE_FORMAT(m.startTime,'%Y') = #{year}
		GROUP BY DATE_FORMAT(m.startTime,'%Y-%m') 
		order by m.startTime
	</select>
	
	<select id="selectVidsByName" resultType="java.lang.Integer">
		select id from u_visitor where name = #{name}
	</select>

</mapper>