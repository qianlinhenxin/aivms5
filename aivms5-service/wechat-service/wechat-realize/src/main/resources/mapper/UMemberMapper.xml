<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.qlhx.dao.UMemberMapper">
	<resultMap id="BaseResultMap" type="com.qlhx.model.UMember">
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="nickname" property="nickname" jdbcType="VARCHAR" />
		<result column="email" property="email" jdbcType="VARCHAR" />
		<result column="pswd" property="pswd" jdbcType="VARCHAR" />
		<result column="create_time" property="createTime" jdbcType="VARCHAR" />
		<result column="last_login_time" property="lastLoginTime"
			jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="BIGINT" />
		<result column="sex" property="sex" jdbcType="INTEGER" />
		<result column="nation" property="nation" jdbcType="INTEGER" />
		<result column="birthday" property="birthday" jdbcType="VARCHAR" />
		<result column="address" property="address" jdbcType="VARCHAR" />
		<result column="idNum" property="idNum" jdbcType="VARCHAR" />
		<result column="photo" property="photo" jdbcType="VARCHAR" />
		<result column="issuing" property="issuing" jdbcType="VARCHAR" />
		<result column="validityDateStart" property="validityDateStart"
			jdbcType="VARCHAR" />
		<result column="validityDateEnd" property="validityDateEnd"
			jdbcType="VARCHAR" />
		<result column="phone" property="phone" jdbcType="VARCHAR" />
		<result column="depID" property="depID" jdbcType="INTEGER" />
		<result column="telephone" property="telephone" jdbcType="VARCHAR" />
		<result column="ecardNum" property="ecardNum" jdbcType="VARCHAR" />
		<result column="ecardEndTime" property="ecardEndTime" jdbcType="VARCHAR" />
		<result column="pinYin" property="pinYin" jdbcType="VARCHAR" />
		<result column="syncId" property="syncId" jdbcType="INTEGER" />
		<result column="companyNum" property="companyNum" jdbcType="VARCHAR" />
	</resultMap>
	<sql id="Base_Column_List">
		id, nickname, email, pswd, create_time,
		last_login_time,status,sex,nation,birthday,address,idNum,photo,issuing,DATE_FORMAT(validityDateStart,'%Y-%m-%d')
		validityDateStart,validityDateEnd,phone,depID,telephone,ecardNum,DATE_FORMAT(ecardEndTime,'%Y-%m-%d')
		ecardEndTime
	</sql>
	<sql id="limit_sql">
		<if test="page_sql != null and page_sql != ''">
			${page_sql}
		</if>
	</sql>

	<sql id="where_all">
		<where>
			<if test="name != null and name !='' ">
				and u.nickname like CONCAT("%",#{name,jdbcType=VARCHAR},"%")
			</if>
			<if test="cardId != null and cardId !='' ">
				and u.idNum like CONCAT("%",#{cardId,jdbcType=VARCHAR},"%")
			</if>
			<if test="companyCode != null and companyCode !='' ">
				and u.companyCode = #{companyCode,jdbcType=VARCHAR}
			</if>
			<if test="areaCode != null and areaCode !='' ">
				and u.areaCode = #{areaCode,jdbcType=VARCHAR}
			</if>
			<if test="company != null and company !='' ">
				and u.type != 0
			</if>
			<if test="today != null and today !='' ">
				and DATE_FORMAT(now(),'%Y-%m-%d') = DATE_FORMAT(u.native_createDate,'%Y-%m-%d')
			</if>
		</where>
	</sql>
	<select id="findAll" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from u_member
		<include refid="where_all" />
		<include refid="limit_sql" />
	</select>
	<select id="findCount" resultType="java.lang.Integer">
		select count(1) from u_member u
		<include refid="where_all" />
	</select>

	<!-- 用户权限分配的分页查询 -->
	<select id="findUserAndRole" resultType="com.qlhx.model.UMember">
		select
		u.*,d.value deptname,c.companyName from
		u_member u
		left join u_department d on d.id = u.depID and u.areaCode = d.areaCode
		left join u_company c on u.companyCode = c.companyCode
		<include refid="where_all" />
		group by u.primaryId
		order by u.native_createDate desc
		<include refid="limit_sql" />
		
	</select>
	<select id="selectRoleByUserId" resultType="com.qlhx.model.URoleBo">
		select ur.id,ur.name,ur.type,ifnull(uu.id,0)marker,uu.id userId from
		u_role ur
		left join u_member_role uur on uur.rid = ur.id and uur.uid =
		#{id,jdbcType=BIGINT}
		left join (select
		id from u_member where id
		=#{id,jdbcType=BIGINT}) uu on uu.id = uur.uid
		group by ur.id
		<!-- 勾选不上自己调整sql语句，由于mysql版本不同，所以不支持，可以看看Demo项目 http://shiro.itboy.net 
			select ur.id,ur.name,ur.type,ifnull(uur.uid,0) marker from u_role ur left 
			join(select * from u_member_role where uid=#{id,jdbcType=BIGINT}) uur on uur.rid 
			= ur.id -->
	</select>

	<!-- 根据邮箱|帐号查询 -->
	<select id="findUserByEmail" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from u_member
		where email = #{email,jdbcType=VARCHAR}
	</select>

	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Long">
		select
		<include refid="Base_Column_List" />
		from u_member
		where id = #{id,jdbcType=BIGINT}
	</select>

	<select id="selectUserInfoByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Long">
		select
		nickname,sex,nation,phone,telephone,syncId,depID
		from u_member
		where id = #{id,jdbcType=BIGINT}
	</select>

	<delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
		delete from u_member
		where id = #{id,jdbcType=BIGINT}
	</delete>
	<insert id="insert" useGeneratedKeys="true" keyProperty="id"
		parameterType="com.qlhx.model.UMember">
		insert into u_member (id, nickname, email,
		pswd,
		create_time, last_login_time,status,pinYin
		)
		values
		(#{id,jdbcType=BIGINT},
		#{nickname,jdbcType=VARCHAR},
		#{email,jdbcType=VARCHAR},
		#{pswd,jdbcType=VARCHAR},
		#{createTime,jdbcType=VARCHAR},
		#{lastLoginTime,jdbcType=VARCHAR},#{status,jdbcType=BIGINT},#{pinYin,jdbcType=VARCHAR}
		)
	</insert>
	<insert id="insertSelective" useGeneratedKeys="true"
		keyProperty="id" parameterType="com.qlhx.model.UMember">
		insert into u_member
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="nickname != null">
				nickname,
			</if>
			<if test="email != null">
				email,
			</if>
			<if test="pswd != null">
				pswd,
			</if>
			<if test="createTime != null">
				create_time,
			</if>
			<if test="lastLoginTime != null">
				last_login_time,
			</if>
			<if test="status != null">
				status,
			</if>
			<if test="sex != null">
				sex,
			</if>
			<if test="nation != null">
				nation,
			</if>
			<if test="birthday != null and birthday!=''">
				birthday,
			</if>
			<if test="address != null">
				address,
			</if>
			<if test="idNum != null">
				idNum,
			</if>
			<if test="photo != null">
				photo,
			</if>
			<if test="issuing != null">
				issuing,
			</if>
			<if test="validityDateStart != null and validityDateStart!=''">
				validityDateStart,
			</if>
			<if test="validityDateEnd != null">
				validityDateEnd,
			</if>
			<if test="phone != null">
				phone,
			</if>
			<if test="depID != null">
				depID,
			</if>
			<if test="telephone != null">
				telephone,
			</if>
			<if test="ecardNum != null">
				ecardNum,
			</if>
			<if test="ecardEndTime != null and ecardEndTime!=''">
				ecardEndTime,
			</if>
			<if test="pinYin != null">
				pinYin,
			</if>
			<if test="syncId != null">
				syncId,
			</if>
			<if test="companyNum != null">
				companyNum,
			</if>
			<if test="primaryId != null">
				primaryId,
			</if>
			<if test="companyCode != null">
				companyCode,
			</if>
			<if test="areaCode != null">
				areaCode,
			</if>
			<if test="terminalCode != null">
				terminalCode,
			</if>
			<if test="native_createDate != null">
				native_createDate,
			</if>
			<if test="native_updateDate != null">
				native_updateDate,
			</if>
			<if test="tabTime != null">
				tabTime,
			</if>
			<if test="uploadTime != null">
				uploadTime,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=BIGINT},
			</if>
			<if test="nickname != null">
				#{nickname,jdbcType=VARCHAR},
			</if>
			<if test="email != null">
				#{email,jdbcType=VARCHAR},
			</if>
			<if test="pswd != null">
				#{pswd,jdbcType=VARCHAR},
			</if>
			<if test="createTime != null">
				#{createTime,jdbcType=VARCHAR},
			</if>
			<if test="lastLoginTime != null">
				#{lastLoginTime,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				#{status,jdbcType=BIGINT},
			</if>
			<if test="sex != null">
				#{sex,jdbcType=INTEGER},
			</if>
			<if test="nation != null">
				#{nation,jdbcType=INTEGER},
			</if>
			<if test="birthday != null and birthday!=''">
				#{birthday,jdbcType=VARCHAR},
			</if>
			<if test="address != null">
				#{address,jdbcType=VARCHAR},
			</if>
			<if test="idNum != null">
				#{idNum,jdbcType=VARCHAR},
			</if>
			<if test="photo != null">
				#{photo,jdbcType=VARCHAR},
			</if>
			<if test="issuing != null">
				#{issuing,jdbcType=VARCHAR},
			</if>
			<if test="validityDateStart != null and validityDateStart!=''">
				#{validityDateStart,jdbcType=VARCHAR},
			</if>
			<if test="validityDateEnd != null">
				#{validityDateEnd,jdbcType=VARCHAR},
			</if>
			<if test="phone != null">
				#{phone,jdbcType=VARCHAR},
			</if>
			<if test="depID != null">
				#{depID,jdbcType=INTEGER},
			</if>
			<if test="telephone != null">
				#{telephone,jdbcType=BIGINT},
			</if>
			<if test="ecardNum != null">
				#{ecardNum,jdbcType=VARCHAR},
			</if>
			<if test="ecardEndTime != null and ecardEndTime!=''">
				#{ecardEndTime,jdbcType=VARCHAR},
			</if>
			<if test="pinYin != null">
				#{pinYin,jdbcType=VARCHAR},
			</if>
			<if test="syncId != null">
				#{syncId,jdbcType=INTEGER},
			</if>
			<if test="companyNum != null">
				#{companyNum,jdbcType=VARCHAR},
			</if>
			<if test="primaryId != null">
				#{primaryId,jdbcType=BIGINT},
			</if>
			<if test="companyCode != null">
				#{companyCode,jdbcType=VARCHAR},
			</if>
			<if test="areaCode != null">
				#{areaCode,jdbcType=VARCHAR},
			</if>
			<if test="terminalCode != null">
				#{terminalCode,jdbcType=VARCHAR},
			</if>
			<if test="native_createDate != null">
				#{native_createDate},
			</if>
			<if test="native_updateDate != null">
				#{native_updateDate},
			</if>
			<if test="tabTime != null">
				#{tabTime},
			</if>
			<if test="uploadTime != null">
				#{uploadTime},
			</if>
		</trim>
	</insert>

	<insert id="insertMembers" parameterType="java.util.List">

        <![CDATA[
          insert into u_member(
               nickname, email,pswd,create_time,status,sex,nation,birthday,address,idNum,photo,issuing,validityDateStart,validityDateEnd,phone,depID,telephone,ecardNum,ecardEndTime,pinYin)
               values
      ]]>
		<foreach collection="list" item="item" close=";" separator=",">
            <![CDATA[
          (
              #{item.nickname,jdbcType=VARCHAR},
                    #{item.email,jdbcType=VARCHAR},
                    #{item.pswd,jdbcType=VARCHAR},
                    #{item.createTime,jdbcType=VARCHAR},
                    #{item.status,jdbcType=BIGINT},
                    #{item.sex,jdbcType=INTEGER},
                    #{item.nation,jdbcType=INTEGER},
                    #{item.birthday,jdbcType=VARCHAR},
                    #{item.address,jdbcType=VARCHAR},
                    #{item.idNum,jdbcType=VARCHAR},
                    #{item.photo,jdbcType=VARCHAR},
                    #{item.issuing,jdbcType=VARCHAR},
                    #{item.validityDateStart,jdbcType=VARCHAR},
                    #{item.validityDateEnd,jdbcType=VARCHAR},
                    #{item.phone,jdbcType=VARCHAR},
                    #{item.depID,jdbcType=INTEGER},
                    #{item.telephone,jdbcType=BIGINT},
                    #{item.ecardNum,jdbcType=VARCHAR},
                    #{item.ecardEndTime,jdbcType=VARCHAR},
                    #{item.pinYin,jdbcType=VARCHAR}
          )
      ]]>
		</foreach>
	</insert>

	<update id="updateByPrimaryKeySelective" parameterType="com.qlhx.model.UMember">
		update u_member
		<set>
			<if test="nickname != null">
				nickname = #{nickname,jdbcType=VARCHAR},
			</if>
			<if test="email != null">
				email = #{email,jdbcType=VARCHAR},
			</if>
			<if test="pswd != null">
				pswd = #{pswd,jdbcType=VARCHAR},
			</if>
			<if test="createTime != null">
				create_time = #{createTime,jdbcType=VARCHAR},
			</if>
			<if test="lastLoginTime != null">
				last_login_time = #{lastLoginTime,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				status = #{status,jdbcType=BIGINT},
			</if>
			<if test="sex != null">
				sex = #{sex,jdbcType=INTEGER},
			</if>
			<if test="nation != null">
				nation = #{nation,jdbcType=INTEGER},
			</if>
			<if test="birthday != null and birthday != ''">
				birthday = #{birthday,jdbcType=VARCHAR},
			</if>
			<if test="address != null">
				address = #{address,jdbcType=VARCHAR},
			</if>
			<if test="idNum != null">
				idNum = #{idNum,jdbcType=VARCHAR},
			</if>
			<if test="photo != null">
				photo = #{photo,jdbcType=VARCHAR},
			</if>
			<if test="issuing != null">
				issuing = #{issuing,jdbcType=VARCHAR},
			</if>
			<if test="validityDateStart != null and validityDateStart != ''">
				validityDateStart =
				#{validityDateStart,jdbcType=VARCHAR},
			</if>
			<if test="validityDateEnd != null">
				validityDateEnd = #{validityDateEnd,jdbcType=VARCHAR},
			</if>
			<if test="phone != null">
				phone = #{phone,jdbcType=VARCHAR},
			</if>
			<if test="depID != null">
				depID = #{depID,jdbcType=INTEGER},
			</if>
			<if test="telephone != null">
				telephone = #{telephone,jdbcType=BIGINT},
			</if>
			<if test="ecardNum != null">
				ecardNum = #{ecardNum,jdbcType=VARCHAR},
			</if>
			<if test="ecardEndTime != null and ecardEndTime!=''">
				ecardEndTime = #{ecardEndTime,jdbcType=VARCHAR},
			</if>
			<if test="pinYin != null">
				pinYin = #{pinYin,jdbcType=VARCHAR},
			</if>
			<if test="native_updateDate != null">
				native_updateDate = #{native_updateDate},
			</if>

		</set>
		where primaryId = #{primaryId,jdbcType=BIGINT}
	</update>
	
	<update id="updateByCompanyCodeAndId" parameterType="com.qlhx.model.UMember">
		update u_member
		<set>
			<if test="nickname != null">
				nickname = #{nickname,jdbcType=VARCHAR},
			</if>
			<if test="email != null">
				email = #{email,jdbcType=VARCHAR},
			</if>
			<if test="pswd != null">
				pswd = #{pswd,jdbcType=VARCHAR},
			</if>
			<if test="createTime != null">
				create_time = #{createTime,jdbcType=VARCHAR},
			</if>
			<if test="lastLoginTime != null">
				last_login_time = #{lastLoginTime,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				status = #{status,jdbcType=BIGINT},
			</if>
			<if test="sex != null">
				sex = #{sex,jdbcType=INTEGER},
			</if>
			<if test="nation != null">
				nation = #{nation,jdbcType=INTEGER},
			</if>
			<if test="birthday != null and birthday != ''">
				birthday = #{birthday,jdbcType=VARCHAR},
			</if>
			<if test="address != null">
				address = #{address,jdbcType=VARCHAR},
			</if>
			<if test="idNum != null">
				idNum = #{idNum,jdbcType=VARCHAR},
			</if>
			<if test="photo != null">
				photo = #{photo,jdbcType=VARCHAR},
			</if>
			<if test="issuing != null">
				issuing = #{issuing,jdbcType=VARCHAR},
			</if>
			<if test="validityDateStart != null and validityDateStart != ''">
				validityDateStart =
				#{validityDateStart,jdbcType=VARCHAR},
			</if>
			<if test="validityDateEnd != null">
				validityDateEnd = #{validityDateEnd,jdbcType=VARCHAR},
			</if>
			<if test="phone != null">
				phone = #{phone,jdbcType=VARCHAR},
			</if>
			<if test="depID != null">
				depID = #{depID,jdbcType=INTEGER},
			</if>
			<if test="telephone != null">
				telephone = #{telephone,jdbcType=BIGINT},
			</if>
			<if test="ecardNum != null">
				ecardNum = #{ecardNum,jdbcType=VARCHAR},
			</if>
			<if test="ecardEndTime != null and ecardEndTime!=''">
				ecardEndTime = #{ecardEndTime,jdbcType=VARCHAR},
			</if>
			<if test="pinYin != null">
				pinYin = #{pinYin,jdbcType=VARCHAR},
			</if>
			<if test="native_updateDate != null">
				native_updateDate = #{native_updateDate},
			</if>
			<if test="tabTime != null">
				tabTime = #{tabTime},
			</if>
			<if test="uploadTime != null">
				uploadTime = #{uploadTime},
			</if>

		</set>
		where areaCode = #{areaCode,jdbcType=VARCHAR} and id = #{id,jdbcType=BIGINT}
	</update>
	
	<update id="updateByPrimaryKey" parameterType="com.qlhx.model.UMember">
		update u_member
		set
		nickname = #{nickname,jdbcType=VARCHAR},
		email =
		#{email,jdbcType=VARCHAR},
		pswd = #{pswd,jdbcType=VARCHAR},
		create_time
		= #{createTime,jdbcType=VARCHAR},
		last_login_time =
		#{lastLoginTime,jdbcType=VARCHAR},
		status = #{status,jdbcType=BIGINT}
		where id = #{id,jdbcType=BIGINT}
	</update>
	
	<select id="selectMemberByPama" resultType="com.qlhx.model.UMember">
		SELECT * FROM u_member
		WHERE 
		id = #{id} 
		AND companyCode = #{companyCode} 		
	</select>
	
	<select id="countReport" resultType="java.util.Map">
		SELECT c.companyName name ,count(m.id) y FROM ${tableName} m , u_company c where m.companyCode = c.companyCode group by m.companyCode,c.companyName
	</select>
	
	<select id="newCountReportByMonth" resultType="java.util.Map">
		select DATE_FORMAT(m.native_createDate,'%Y-%m-%d') name ,count(m.id) y  
		from ${tableName} m,u_company c where m.companyCode = c.companyCode 
		<if test="companyCode != null">
			and m.companyCode = #{companyCode}
		</if>
		and DATE_FORMAT(m.native_createDate,'%Y-%m') = #{yearMonth}
		GROUP BY DATE_FORMAT(m.native_createDate,'%Y-%m-%d') 
		order by m.native_createDate
	</select>
	
	<select id="newCountReportByYear" resultType="java.util.Map">
		select DATE_FORMAT(m.native_createDate,'%Y-%m') name ,count(m.id) y  
		from ${tableName} m,u_company c where m.companyCode = c.companyCode 
		<if test="companyCode != null">
			and m.companyCode = #{companyCode}
		</if>
		and DATE_FORMAT(m.native_createDate,'%Y') = #{year}
		GROUP BY DATE_FORMAT(m.native_createDate,'%Y-%m') 
		order by m.native_createDate
	</select>

<!-- 登录 -->
	<select id="login" resultType="com.qlhx.model.UMember">
		SELECT
		<include refid="Base_Column_List" />
		FROM u_member
		where email = #{email,jdbcType=VARCHAR} 
		and pswd = #{pswd,jdbcType=VARCHAR}
		and areaCode = #{areaCode,jdbcType=VARCHAR}
	</select>
	
	<select id="selectByPhone" resultType="com.qlhx.model.UMember">
		SELECT
		*
		FROM u_member
		where phone = #{phone,jdbcType=VARCHAR} 
		and areaCode = #{areaCode,jdbcType=VARCHAR}
		and status = 1
		limit 0,1
	</select>
	
	<select id="selectByUid" resultType="com.qlhx.model.UMember">
		SELECT
		*
		FROM u_member
		where id = #{uid,jdbcType=VARCHAR} 
		and areaCode = #{areaCode,jdbcType=VARCHAR}
	</select>
	
	<delete id="deleteByUid">
		delete from u_member
		where id = #{uid} and areaCode = #{areaCode} 
	</delete>
</mapper>
